<!DOCTYPE html>
<html lang="{{ site.lang }}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{% if title %}{{ title }}{% else %}{{ site.title }}{% endif %}</title>
    {% if description %}
      <meta name="description" content="{{ description }}" />
    {% else %}
      <meta name="description" content="{{ site.description }}" />
    {% endif %}

    {% if noindex %}
      <meta name="robots" content="noindex,nofollow" />
    {% else %}
      <meta name="robots" content="index,follow" />
    {% endif %}

    <link rel="canonical" href="{{ page.url | absoluteUrl(site.url) }}" />

    <meta property="og:site_name" content="{{ site.title }}" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="{{ page.url | absoluteUrl(site.url) }}" />
    <meta property="og:title" content="{% if title %}{{ title }}{% else %}{{ site.title }}{% endif %}" />
    <meta property="og:description" content="{% if description %}{{ description }}{% else %}{{ site.description }}{% endif %}" />
    <meta property="og:image" content="{{ '/assets/images/logo.jpeg' | absoluteUrl(site.url) }}" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="{% if title %}{{ title }}{% else %}{{ site.title }}{% endif %}" />
    <meta name="twitter:description" content="{% if description %}{{ description }}{% else %}{{ site.description }}{% endif %}" />
    <meta name="twitter:image" content="{{ '/assets/images/logo.jpeg' | absoluteUrl(site.url) }}" />

    <link rel="icon" href="/assets/images/logo.jpeg" />
    <link rel="apple-touch-icon" href="/assets/images/logo.jpeg" />

    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "{{ site.title }}",
        "url": "{{ '/' | absoluteUrl(site.url) }}"
      }
    </script>

    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "{{ site.title }}",
        "url": "{{ '/' | absoluteUrl(site.url) }}",
        "logo": "{{ '/assets/images/logo.jpeg' | absoluteUrl(site.url) }}"
      }
    </script>

    <link rel="stylesheet" href="/assets/css/site.css" />
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">{% if title %}{{ title }}{% else %}{{ site.title }}{% endif %}</h1>
      <h2 class="project-tagline">{% if description %}{{ description }}{% else %}{{ site.description }}{% endif %}</h2>

      <nav class="nav">
        <a class="btn" href="/recommend/">首页</a>
        <a class="btn" href="/about/">关于</a>
        <a class="btn" href="/disclaimer/">免责声明</a>
        <a class="btn" href="/privacy/">隐私政策</a>
        <a class="btn" href="/contact/">联系</a>
        <select id="lang-select" class="btn" style="max-width: 140px;">
          <option value="zh">中文</option>
          <option value="en">English</option>
          <option value="zh-hant">中文繁體</option>
          <option value="ru">Русский</option>
          <option value="fa">فارسی</option>
        </select>
      </nav>
    </header>

    <main id="content" class="main-content" role="main">
      {{ content | safe }}

      <footer class="site-footer">
        <span class="site-footer-credits">版权所有 <a href="/">{{ site.title }}</a>.</span>
      </footer>
    </main>

    <script>
      (function () {
        var supported = ["zh", "en", "zh-hant", "ru", "fa"];
        var prefixMap = {
          "zh": "",
          "en": "/en",
          "zh-hant": "/zh-hant",
          "ru": "/ru",
          "fa": "/fa"
        };

        function getPathWithoutLangPrefix(pathname) {
          for (var i = 0; i < supported.length; i++) {
            var lang = supported[i];
            var prefix = prefixMap[lang];
            if (prefix && (pathname === prefix + "/" || pathname.indexOf(prefix + "/") === 0)) {
              var rest = pathname.slice(prefix.length);
              return rest || "/";
            }
          }
          return pathname || "/";
        }

        function getLangFromPath(pathname) {
          for (var i = 0; i < supported.length; i++) {
            var lang = supported[i];
            var prefix = prefixMap[lang];
            if (prefix && (pathname === prefix + "/" || pathname.indexOf(prefix + "/") === 0)) return lang;
          }
          return "zh";
        }

        function normalizeNavigatorLang(l) {
          if (!l) return null;
          var s = String(l).toLowerCase();
          if (s === "zh-tw" || s === "zh-hk" || s === "zh-mo" || s.indexOf("zh-hant") === 0) return "zh-hant";
          if (s.indexOf("zh") === 0) return "zh";
          if (s.indexOf("en") === 0) return "en";
          if (s.indexOf("ru") === 0) return "ru";
          if (s.indexOf("fa") === 0) return "fa";
          return null;
        }

        function pickBrowserLang() {
          var langs = (navigator.languages && navigator.languages.length) ? navigator.languages : [navigator.language];
          for (var i = 0; i < langs.length; i++) {
            var v = normalizeNavigatorLang(langs[i]);
            if (v) return v;
          }
          return "zh";
        }

        function buildUrl(targetLang) {
          var basePath = getPathWithoutLangPrefix(location.pathname);
          var prefix = prefixMap[targetLang] || "";
          var p = prefix + basePath;
          if (p === "") p = "/";
          return p + location.search + location.hash;
        }

        var select = document.getElementById("lang-select");
        if (!select) return;

        var currentLang = getLangFromPath(location.pathname);
        var saved = null;
        try {
          saved = localStorage.getItem("site_lang");
        } catch (e) {
          saved = null;
        }

        var target = (saved && supported.indexOf(saved) >= 0) ? saved : pickBrowserLang();

        select.value = currentLang;

        if (!saved && target !== currentLang) {
          location.replace(buildUrl(target));
          return;
        }

        select.addEventListener("change", function () {
          var v = select.value;
          if (supported.indexOf(v) < 0) return;
          try {
            localStorage.setItem("site_lang", v);
          } catch (e) {}
          var url = buildUrl(v);
          if (url !== location.pathname + location.search + location.hash) location.href = url;
        });
      })();
    </script>
  </body>
</html>
