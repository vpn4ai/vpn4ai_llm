<!DOCTYPE html>
{% set currentLang = lang or site.lang %}
{% set canonicalPath = page.url | stripLangPrefix %}
{% set enReadyPaths = [
  '/recommend/',
  '/about/',
  '/disclaimer/',
  '/privacy/',
  '/contact/',
  '/vpn-review-methodology/',
  '/posts/nordvpn-review/',
  '/posts/surfshark-review/',
  '/posts/protonvpn-review/',
  '/posts/purevpn-review/',
  '/posts/expressvpn-review/',
  '/posts/cyberghost-review/',
  '/posts/pia-review/',
  '/posts/ivacy-review/',
  '/posts/mullvad-review/',
  '/posts/strongvpn-review/',
  '/posts/atlas-review/'
] %}
{% set hasEn = canonicalPath in enReadyPaths %}
<html lang="{{ currentLang }}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{% if title %}{{ title }}{% else %}{{ site.title }}{% endif %}</title>
    {% if description %}
      <meta name="description" content="{{ description }}" />
    {% else %}
      <meta name="description" content="{{ site.description }}" />
    {% endif %}

    {% if noindex %}
      <meta name="robots" content="noindex,nofollow" />
    {% else %}
      <meta name="robots" content="index,follow" />
    {% endif %}

    {% if page.url == '/' %}
      <meta name="baidu-site-verification" content="codeva-fiSpow0Rsf" />
    {% endif %}

    <link rel="canonical" href="{{ page.url | absoluteUrl(site.url) }}" />

    {% if hasEn %}
      <link rel="alternate" hreflang="zh" href="{{ canonicalPath | withLangPrefix('zh') | absoluteUrl(site.url) }}" />
      <link rel="alternate" hreflang="en" href="{{ canonicalPath | withLangPrefix('en') | absoluteUrl(site.url) }}" />
    {% endif %}

    <meta property="og:site_name" content="{{ site.title }}" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="{{ page.url | absoluteUrl(site.url) }}" />
    <meta property="og:title" content="{% if title %}{{ title }}{% else %}{{ site.title }}{% endif %}" />
    <meta property="og:description" content="{% if description %}{{ description }}{% else %}{{ site.description }}{% endif %}" />
    <meta property="og:image" content="{{ '/assets/images/logo.jpeg' | absoluteUrl(site.url) }}" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="{% if title %}{{ title }}{% else %}{{ site.title }}{% endif %}" />
    <meta name="twitter:description" content="{% if description %}{{ description }}{% else %}{{ site.description }}{% endif %}" />
    <meta name="twitter:image" content="{{ '/assets/images/logo.jpeg' | absoluteUrl(site.url) }}" />

    <link rel="icon" href="/assets/images/logo.jpeg" />
    <link rel="apple-touch-icon" href="/assets/images/logo.jpeg" />

    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "{{ site.title }}",
        "url": "{{ '/' | absoluteUrl(site.url) }}"
      }
    </script>

    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "{{ site.title }}",
        "url": "{{ '/' | absoluteUrl(site.url) }}",
        "logo": "{{ '/assets/images/logo.jpeg' | absoluteUrl(site.url) }}"
      }
    </script>

    <link rel="stylesheet" href="/assets/css/site.css" />
  </head>
  <body>
    <header class="page-header" role="banner">
      <h1 class="project-name">{% if title %}{{ title }}{% else %}{{ site.title }}{% endif %}</h1>
      <h2 class="project-tagline">{% if description %}{{ description }}{% else %}{{ site.description }}{% endif %}</h2>

      {% set navHome = '首页' %}
      {% set navAbout = '关于' %}
      {% set navDisclaimer = '免责声明' %}
      {% set navPrivacy = '隐私政策' %}
      {% set navContact = '联系' %}
      {% if currentLang == 'en' %}
        {% set navHome = 'Home' %}
        {% set navAbout = 'About' %}
        {% set navDisclaimer = 'Disclaimer' %}
        {% set navPrivacy = 'Privacy' %}
        {% set navContact = 'Contact' %}
      {% endif %}

      <nav class="nav">
        <a class="btn" href="{{ '/recommend/' | withLangPrefix(currentLang) }}">{{ navHome }}</a>
        <a class="btn" href="{{ '/about/' | withLangPrefix(currentLang) }}">{{ navAbout }}</a>
        <a class="btn" href="{{ '/disclaimer/' | withLangPrefix(currentLang) }}">{{ navDisclaimer }}</a>
        <a class="btn" href="{{ '/privacy/' | withLangPrefix(currentLang) }}">{{ navPrivacy }}</a>
        <a class="btn" href="{{ '/contact/' | withLangPrefix(currentLang) }}">{{ navContact }}</a>
        <select id="lang-select" class="btn" style="max-width: 140px;">
          <option value="zh">中文</option>
          <option value="en">English</option>
        </select>
      </nav>
    </header>

    <main id="content" class="main-content" role="main">
      {{ content | safe }}
    </main>

    <script>
      (function () {
        var supported = ["zh", "en"];
        var prefixMap = {
          "zh": "",
          "en": "/en"
        };

        var hasEn = {% if hasEn %}true{% else %}false{% endif %};
        var canonicalPath = "{{ canonicalPath }}";

        function getPathWithoutLangPrefix(pathname) {
          for (var i = 0; i < supported.length; i++) {
            var lang = supported[i];
            var prefix = prefixMap[lang];
            if (prefix && (pathname === prefix + "/" || pathname.indexOf(prefix + "/") === 0)) {
              var rest = pathname.slice(prefix.length);
              return rest || "/";
            }
          }
          return pathname || "/";
        }

        function getLangFromPath(pathname) {
          for (var i = 0; i < supported.length; i++) {
            var lang = supported[i];
            var prefix = prefixMap[lang];
            if (prefix && (pathname === prefix + "/" || pathname.indexOf(prefix + "/") === 0)) return lang;
          }
          return "zh";
        }

        function normalizeNavigatorLang(l) {
          if (!l) return null;
          var s = String(l).toLowerCase();
          if (s.indexOf("zh") === 0) return "zh";
          if (s.indexOf("en") === 0) return "en";
          return null;
        }

        function pickBrowserLang() {
          var langs = (navigator.languages && navigator.languages.length) ? navigator.languages : [navigator.language];
          for (var i = 0; i < langs.length; i++) {
            var v = normalizeNavigatorLang(langs[i]);
            if (v) return v;
          }
          return "en";
        }

        function buildUrl(targetLang) {
          var basePath = getPathWithoutLangPrefix(location.pathname);

          if (targetLang === "en" && !hasEn) {
            basePath = "/recommend/";
          }

          var prefix = prefixMap[targetLang] || "";
          var p = prefix + basePath;
          if (p === "") p = "/";
          return p + location.search + location.hash;
        }

        var select = document.getElementById("lang-select");
        if (!select) return;

        var currentLang = getLangFromPath(location.pathname);
        var saved = null;
        try {
          saved = localStorage.getItem("site_lang");
        } catch (e) {
          saved = null;
        }

        var target = (saved && supported.indexOf(saved) >= 0) ? saved : pickBrowserLang();

        select.value = currentLang;

        if (!saved && target !== currentLang) {
          location.replace(buildUrl(target));
          return;
        }

        select.addEventListener("change", function () {
          var v = select.value;
          if (supported.indexOf(v) < 0) return;
          try {
            localStorage.setItem("site_lang", v);
          } catch (e) {}
          var url = buildUrl(v);
          if (url !== location.pathname + location.search + location.hash) location.href = url;
        });
      })();
    </script>

    <script>
      (function () {
        function isH2(node) {
          return node && node.nodeType === 1 && node.tagName === "H2";
        }

        function isEmptyText(node) {
          return node && node.nodeType === 3 && !String(node.textContent || "").trim();
        }

        function wrapSectionBodies() {
          var main = document.getElementById("content");
          if (!main) return;

          var footer = main.querySelector("footer.site-footer");
          var h2s = [];
          var cursor = main.firstChild;

          while (cursor && cursor !== footer) {
            if (isH2(cursor)) h2s.push(cursor);
            cursor = cursor.nextSibling;
          }

          if (!h2s.length) return;

          for (var i = 0; i < h2s.length; i++) {
            var h2 = h2s[i];
            var next = h2.nextSibling;

            while (isEmptyText(next)) next = next.nextSibling;

            if (next && next.nodeType === 1 && next.classList && next.classList.contains("section-body")) {
              continue;
            }

            var body = document.createElement("div");
            body.className = "section-body";
            if (h2.nextSibling) {
              main.insertBefore(body, h2.nextSibling);
            } else {
              main.appendChild(body);
            }

            var n = body.nextSibling;
            while (n && n !== footer && !isH2(n)) {
              var nn = n.nextSibling;
              body.appendChild(n);
              n = nn;
            }

            if (!body.firstChild) {
              body.parentNode && body.parentNode.removeChild(body);
            }
          }
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", wrapSectionBodies);
        } else {
          wrapSectionBodies();
        }
      })();
    </script>
  </body>
</html>
